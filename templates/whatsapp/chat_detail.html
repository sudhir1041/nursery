{# whatsapp_app/templates/whatsapp_app/chat_detail.html #}
{% extends "whatsapp/base_whatsapp.html" %} {# Use the non-Bootstrap base template #}
{% load static %}

{% block whatsapp_content %}

{# --- Main Chat Container --- #}
{# Uses custom CSS for layout and appearance #}
<div class="chat-detail-container">

    {# --- Chat Header --- #}
    <div class="chat-header">
        <div class="chat-header-info">
            {# Display Contact Name or WA ID #}
            <h4 class="contact-name">{{ contact.name|default:contact.wa_id }}</h4>
            <small class="contact-wa-id">{{ contact.wa_id }}</small>
        </div>
        <div class="chat-header-actions">
            {# Optional: Link to nursery customer profile #}
            {# {% if contact.customer %}
                <a href="{% url 'your_customer_detail_view_name' contact.customer.pk %}" class="custom-button button-outline-secondary button-sm" title="View Customer Profile">
                    <i class="fas fa-user-circle"></i> View Customer
                </a>
            {% endif %} #}
             <a href="{% url 'whatsapp_app:chat_list' %}" class="custom-button button-outline-secondary button-sm" title="Back to Chat List">
                 <i class="fas fa-arrow-left"></i> Back
             </a>
        </div>
    </div>

    {# --- Message Display Area --- #}
    {# Populated and scrolled by chat.js #}
    <div class="chat-messages" id="message-list"
         {# Pass data attributes needed by chat.js #}
         data-contact-wa-id="{{ contact.wa_id }}"
         data-last-timestamp="{{ last_message_timestamp }}"> {# Initial timestamp for polling/WebSocket #}

        {# Loop through messages passed from the view initially #}
        {% for message in messages %}
        <div class="message {% if message.direction == 'OUT' %}outgoing{% else %}incoming{% endif %}" data-message-id="{{ message.message_id }}">
            <div class="message-bubble">
                {# --- Message Content --- #}
                <div class="message-text"> {# Base class for content #}
                    {% if message.message_type == 'text' %}
                        {{ message.text_content|linebreaksbr }} {# Use linebreaksbr for display #}
                    {% elif message.message_type == 'template' %}
                        <span class="template-indicator"><i class="fas fa-file-alt"></i> Template: {{ message.template_name|default:"Unknown" }}</span>
                        {% if message.text_content %}
                        <div class="template-text-content">{{ message.text_content|linebreaksbr }}</div>
                        {% endif %}
                    {% elif message.message_type == 'image' %}
                        <span class="media-indicator"><i class="fas fa-image"></i> [Image Received]</span>
                        {% if message.text_content %}<p class="media-caption">{{ message.text_content|linebreaksbr }}</p>{% endif %}
                        {# Placeholder/Link for actual image - Requires backend endpoint #}
                        {% if message.media_url %}
                            {# Example link - replace with your actual media view URL #}
                            {# <a href="{% url 'whatsapp_app:view_media' message.message_id %}" target="_blank" class="media-preview-link">View Image</a> #}
                             <span class="text-muted">(Media URL available but preview not implemented)</span>
                        {% endif %}
                     {% elif message.message_type == 'video' %}
                        <span class="media-indicator"><i class="fas fa-video"></i> [Video Received]</span>
                        {% if message.text_content %}<p class="media-caption">{{ message.text_content|linebreaksbr }}</p>{% endif %}
                        {# Placeholder/Link #}
                     {% elif message.message_type == 'audio' %}
                         <span class="media-indicator"><i class="fas fa-volume-up"></i> [Audio Received]</span>
                         {# Placeholder/Link #}
                    {% elif message.message_type == 'document' %}
                        <span class="media-indicator"><i class="fas fa-file-alt"></i> [Document: {{ message.filename|default:"Received" }}]</span>
                        {% if message.text_content %}<p class="media-caption">{{ message.text_content|linebreaksbr }}</p>{% endif %}
                        {# Placeholder/Link #}
                        {% if message.media_url %}
                             {# Example link - replace with your actual media view URL #}
                            {# <a href="{% url 'whatsapp_app:view_media' message.message_id %}" target="_blank" class="custom-button button-outline-secondary button-sm media-download-button"><i class="fas fa-download"></i> Download</a> #}
                             <span class="text-muted">(Media URL available but download not implemented)</span>
                        {% endif %}
                    {% else %}
                        {# Fallback for other types #}
                        <span class="media-indicator"><i class="fas fa-file"></i> [{{ message.get_message_type_display|default:message.message_type }}]</span>
                        {% if message.text_content %}<p class="media-caption">{{ message.text_content|linebreaksbr }}</p>{% endif %}
                    {% endif %}
                </div> {# End message-text #}

                {# --- Message Meta (Timestamp & Status) --- #}
                <div class="message-meta">
                    <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
                    {% if message.direction == 'OUT' %}
                        <span class="message-status-icon" title="{{ message.get_status_display }}">
                            {# Logic moved to chat.js getStatusIconHTML for dynamic updates #}
                            {# Initial rendering can be done here if needed, but JS will override #}
                            {% if message.status == 'FAILED' %} <i class="fas fa-exclamation-circle status-icon-failed"></i>
                            {% elif message.status == 'READ' %} <i class="fas fa-check-double status-icon-read"></i>
                            {% elif message.status == 'DELIVERED' %} <i class="fas fa-check-double status-icon-delivered"></i>
                            {% elif message.status == 'SENT' %} <i class="fas fa-check status-icon-sent"></i>
                            {% elif message.status == 'PENDING' %} <i class="fas fa-clock status-icon-pending"></i>
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
            </div> {# End message-bubble #}
        </div> {# End message #}
        {% empty %}
        {# Message shown if no messages exist yet #}
        <p class="text-center text-muted mt-5" id="no-messages-placeholder">No messages in this conversation yet. Start by sending a message below.</p>
        {% endfor %}
    </div> {# End chat-messages #}

    {# --- Message Input Area --- #}
    <div class="chat-input-area">
        {# The form action points to the AJAX view for non-WebSocket sending, #}
        {# but WebSocket sending in chat.js overrides this default action. #}
        {# Keep action for potential non-JS fallback or alternative sending methods. #}
        <form id="manual-message-form" method="post" action="{% url 'whatsapp_app:send_manual_message_ajax' %}" class="whatsapp-form">
             {% csrf_token %}
             {# Add wa_id as hidden input if needed by AJAX view #}
             <input type="hidden" name="wa_id" value="{{ contact.wa_id }}">

             {# Attach Button #}
             <button type="button" id="attach-file-button" class="custom-button button-secondary" title="Attach File">
                 <i class="fas fa-paperclip"></i>
             </button>
             {# Hidden File Input #}
             <input type="file" id="chat-file-input" style="display: none;" accept="image/*,video/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">

            {# Render only the text_content field from the ManualMessageForm #}
            {# Ensure form.text_content widget has class="form-input chat-input" #}
            {{ form.text_content }}

            {# Send Button #}
            <button type="submit" class="custom-button button-primary" title="Send Message">
                <i class="fas fa-paper-plane"></i> {# Icon only for space #}
            </button>
             {# Uploading Indicator #}
             <span id="file-upload-spinner" style="display: none; margin-left: 10px; color: #6c757d;">
                 <i class="fas fa-spinner fa-spin"></i> Uploading...
             </span>
        </form>
         {# Optional: Add error display area for JS #}
         <div id="chat-error-display" style="display: none; color: #dc3545; font-size: 0.9em; margin-top: 5px;"></div>
    </div>

</div> {# End chat-detail-container #}
{% endblock whatsapp_content %}

{% block extra_scripts %} {# Add JavaScript specific to the chat page #}
    {{ block.super }} {# Include JS from base templates #}
    {# Ensure chat.js is included #}
    <script src="{% static 'whatsapp_app/js/chat.js' %}"></script>
{% endblock extra_scripts %}
