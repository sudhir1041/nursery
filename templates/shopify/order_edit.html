{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Edit Shopify Order" }}{% endblock %}

{% block styles %}
<style>
.shopify-order-edit {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 3rem;
    background: #f8f9fa;
    border-radius: 12px;
}

.shopify-order-edit h1 {
    color: #2c3e50;
    font-size: 2.5rem;
    font-weight: 600;
    margin-bottom: 2rem;
    text-align: center;
}

.shopify-order-edit form {
    background: #fff;
    padding: 3rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.shopify-order-edit form p {
    margin-bottom: 2rem;
}

.shopify-order-edit label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.75rem;
    color: #2c3e50;
    font-size: 1.1rem;
}

.shopify-order-edit input,
.shopify-order-edit select,
.shopify-order-edit textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

.shopify-order-edit input:focus,
.shopify-order-edit select:focus,
.shopify-order-edit textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
}

.shopify-order-edit .btn {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    color: white;
}

.shopify-order-edit .btn-primary {
    background-color: #3498db;
}

.shopify-order-edit .btn-primary:hover {
    background-color: #2980b9;
    transform: translateY(-1px);
}

.shopify-order-edit .btn-secondary {
    background-color: #95a5a6;
    margin-left: 1.5rem;
}

.shopify-order-edit .btn-secondary:hover {
    background-color: #7f8c8d;
    transform: translateY(-1px);
}

.shopify-order-edit .alert {
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid transparent;
    font-weight: 500;
}

.shopify-order-edit .alert-success {
    background-color: #dff7e9;
    border-color: #c3e6cb;
    color: #155724;
}

.shopify-order-edit .alert-danger {
    background-color: #fde8e8;
    border-color: #f5c6cb;
    color: #721c24;
}

.shopify-order-edit .alert-warning {
    background-color: #fff8e6;
    border-color: #ffeeba;
    color: #856404;
}

.shopify-order-edit .form-field-error ul {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
    color: #e74c3c;
    font-size: 0.9rem;
}

.shopify-order-edit .form-field-error li {
    margin: 0.25rem 0;
    padding: 0;
}

.shopify-order-edit a {
    color: #3498db;
    text-decoration: none;
    transition: all 0.3s ease;
}

.shopify-order-edit a:hover {
    color: #2980b9;
    text-decoration: none;
}

.shopify-order-edit .actions {
    margin-top: 2.5rem;
    text-align: center;
}

.shopify-order-edit .back-link {
    margin-top: 2rem;
    text-align: center;
    font-size: 1.1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="shopify-order-edit">
    <h1>{{ page_title }}</h1>

    <div id="form-messages" class="mb-3"></div>

    <form id="order-edit-form" method="post" novalidate
          action="{% url 'shopify_order_edit' order.shopify_id %}"
          data-url="{% url 'shopify_order_edit' order.shopify_id %}">
        {% csrf_token %}

        {% for field in form %}
        <div class="form-group">
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}
            <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
            {% if field.errors %}
            <div class="form-field-error" data-for="{{ field.name }}">
                <ul>
                    {% for error in field.errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        <div class="actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{% url 'shopify_order_detail' order.shopify_id %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>

    <div class="back-link">
        <a href="{% url 'shopify_order_detail' order.shopify_id %}">‚Üê Back to Order Details</a>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('order-edit-form');
    const messagesDiv = document.getElementById('form-messages');
    if (!form || !form.dataset.url) {
        console.warn('Edit form or data-url not found.');
        return;
    }
    const formUrl = form.dataset.url;

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        messagesDiv.innerHTML = '';
        document.querySelectorAll('.form-field-error').forEach(el => el.innerHTML = '');

        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) submitButton.disabled = true;

        try {
            const response = await fetch(formUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            if (!response.ok) {
                if (response.status === 400) {
                    const data = await response.json();
                    throw { type: 'validation', errors: data.errors };
                }
                throw { type: 'server', status: response.status };
            }

            const data = await response.json();
            if (data.status === 'success') {
                messagesDiv.innerHTML = `<div class="alert alert-success">${data.message || 'Update successful!'}</div>`;
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            } else {
                messagesDiv.innerHTML = `<div class="alert alert-warning">${data.message || 'An unexpected issue occurred.'}</div>`;
            }
        } catch (errorInfo) {
            console.error('Form submission error:', errorInfo);
            if (errorInfo && errorInfo.type === 'validation') {
                messagesDiv.innerHTML = `<div class="alert alert-danger">Please correct the errors below.</div>`;
                displayFormErrors(errorInfo.errors);
            } else {
                messagesDiv.innerHTML = `<div class="alert alert-danger">An error occurred (Status: ${errorInfo.status || 'Network'}). Please try again.</div>`;
            }
        } finally {
            if (submitButton) submitButton.disabled = false;
        }
    });

    function displayFormErrors(errors) {
        for (const fieldName in errors) {
            const fieldErrors = errors[fieldName];
            const fieldElement = form.querySelector(`[name="${fieldName}"]`);

            if (fieldElement) {
                let errorContainer = fieldElement.parentElement.querySelector(`.form-field-error[data-for="${fieldName}"]`);
                if (!errorContainer) {
                    errorContainer = document.createElement('div');
                    errorContainer.classList.add('form-field-error');
                    errorContainer.dataset.for = fieldName;
                    fieldElement.insertAdjacentElement('afterend', errorContainer);
                }
                const errorList = document.createElement('ul');
                fieldErrors.forEach(errorMsg => {
                    const listItem = document.createElement('li');
                    listItem.textContent = errorMsg;
                    errorList.appendChild(listItem);
                });
                errorContainer.innerHTML = '';
                errorContainer.appendChild(errorList);
            } else if (fieldName === '__all__') {
                const nonFieldErrors = errors[fieldName].map(msg => `<p>${msg}</p>`).join('');
                messagesDiv.innerHTML += `<div class="alert alert-danger">${nonFieldErrors}</div>`;
            }
        }
    }
});
</script>
{% endblock extra_js %}
